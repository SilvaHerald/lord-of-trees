---
import { defaultLang, useTranslations, type Language } from '@libs/i18n/config';
import '@styles/global.css';
import RSSLinks from '@components/RSSLinks.astro';
import HeaderLogo from '@components/HeaderLogo.astro';
import HeaderNav from '@components/HeaderNav.astro';
import ThemeToggle from '@components/ThemeToggle.astro';
import LanguageSwitcher from '@components/LanguageSwitcher.astro';
import HeaderSearchButton from '@components/HeaderSearchButton.astro';
import MobileMenuButton from '@components/MobileMenuButton.astro';
import MobileMenu from '@components/MobileMenu.astro';
import FooterBrand from '@components/FooterBrand.astro';
import FooterTravelCategories from '@components/FooterTravelCategories.astro';
import FooterTravelResources from '@components/FooterTravelResources.astro';
import FooterTravelStats from '@components/FooterTravelStats.astro';
import FooterBottom from '@components/FooterBottom.astro';
import MobileSettingsModal from '@components/MobileSettingsModal.astro';
import MobileSettingsButton from '@components/MobileSettingsButton.astro';
import MobileSearchModal from '@components/MobileSearchModal.astro';
export interface Props {
  title: string;
  description: string;
  lang?: Language;
  image?: string;
}

const canonicalURL = new URL(Astro.url.pathname, Astro.site);
const {
  title,
  description,
  lang = defaultLang,
  image = '/images/travel-og-default.jpg',
} = Astro.props;
const t = useTranslations(lang);

let baseUrl = '/';

if (lang !== defaultLang) {
  baseUrl = `/${lang}`;
}
---

<!doctype html>
<html lang="en">
  <head>
    <meta charset="UTF-8" />
    <meta name="viewport" content="width=device-width, initial-scale=1.0" />
    <link rel="icon" type="image/svg+xml" href="/favicon.svg" />
    <meta name="generator" content={Astro.generator} />
    <meta name="color-scheme" content="dark light" />
    <!-- Primary Meta Tags -->
    <title>{title}</title>
    <meta name="title" content={title} />
    <meta name="description" content={description} />
    <link rel="canonical" href={canonicalURL} />

    <!-- Open Graph / Facebook -->
    <meta property="og:type" content="website" />
    <meta property="og:url" content={Astro.url} />
    <meta property="og:title" content={title} />
    <meta property="og:description" content={description} />
    <meta property="og:image" content={new URL(image, Astro.url)} />

    <!-- Twitter -->
    <meta property="twitter:card" content="summary_large_image" />
    <meta property="twitter:url" content={Astro.url} />
    <meta property="twitter:title" content={title} />
    <meta property="twitter:description" content={description} />
    <meta property="twitter:image" content={new URL(image, Astro.url)} />

    <!-- RSS Feed -->
    <link
      rel="alternate"
      type="application/rss+xml"
      title="Travel Stories RSS Feed"
      href="/rss.xml"
    />

    <!-- Fonts -->
    <!-- <link rel="preconnect" href="https://fonts.googleapis.com" />
    <link rel="preconnect" href="https://fonts.gstatic.com" crossorigin />
    <link
      href="https://fonts.googleapis.com/css2?family=Inter:wght@400;500;600;700;800;900&family=Playfair+Display:wght@400;500;600;700;800;900&display=swap"
      rel="stylesheet"
    /> -->

    <!-- RSS Feeds -->
    <RSSLinks />

    <!-- Theme Script -->
    <script is:inline>
      function getThemePreference() {
        if (typeof localStorage !== 'undefined' && localStorage.getItem('theme')) {
          return localStorage.getItem('theme');
        }
        return window.matchMedia('(prefers-color-scheme: dark)').matches ? 'light' : 'light';
      }

      const isDark = getThemePreference() === 'dark';
      document.documentElement.classList[isDark ? 'add' : 'remove']('dark');

      if (typeof localStorage !== 'undefined') {
        const observer = new MutationObserver(() => {
          const isDark = document.documentElement.classList.contains('dark');
          localStorage.setItem('theme', isDark ? 'dark' : 'light');
        });
        observer.observe(document.documentElement, {
          attributes: true,
          attributeFilter: ['class'],
        });
      }
    </script>
  </head>

  <body
    class="bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 font-sans text-slate-900 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900 dark:text-white"
  >
    <!-- Header -->
    <header
      class="sticky top-0 z-50 border-b border-amber-200 bg-white/80 shadow-sm backdrop-blur-md dark:border-slate-700 dark:bg-slate-900/80"
    >
      <nav class="mx-auto max-w-7xl px-4 sm:px-6 lg:px-8">
        <div class="flex items-center justify-between py-4">
          <!-- Mobile menu button -->
          <MobileMenuButton />

          <!-- Logo -->
          <HeaderLogo lang={lang} baseUrl={baseUrl} />

          <!-- Navigation -->
          <HeaderNav lang={lang} baseUrl={baseUrl} />

          <!-- Search Icon -->
          <HeaderSearchButton />
          <!-- Theme Toggle & Mobile Menu -->
          <div class="hidden items-center space-x-4 lg:flex">
            <!-- Theme Toggle -->
            <ThemeToggle />

            <!-- Language Switcher -->
            <LanguageSwitcher />
          </div>

          <!-- Mobile Actions (Only the button, not the modal) -->
          <!-- Settings Button -->
          <MobileSettingsButton id="mobile-settings-btn" buttonClass="lg:hidden" />
        </div>
      </nav>
    </header>

    <!-- Mobile menu -->
    <MobileMenu lang={lang} baseUrl={baseUrl} />
    <MobileSearchModal lang={lang} />
    <!-- Settings Modal (OUTSIDE header, at root level) -->
    <MobileSettingsModal
      lang={lang}
      availableLanguages={[
        { code: 'en', name: 'English', flag: 'ðŸ‡ºðŸ‡¸' },
        { code: 'vi', name: 'Tiáº¿ng Viá»‡t', flag: 'ðŸ‡»ðŸ‡³' },
      ]}
    />

    <!-- Main Content -->
    <slot />

    <!-- Footer -->
    <footer class="relative overflow-hidden bg-slate-900 text-white dark:bg-slate-950">
      <!-- Background Pattern -->
      <div class="absolute inset-0 opacity-5">
        <svg class="h-full w-full" viewBox="0 0 100 100">
          <defs>
            <pattern
              id="travel-pattern"
              x="0"
              y="0"
              width="20"
              height="20"
              patternUnits="userSpaceOnUse"
            >
              <circle cx="10" cy="10" r="2" fill="currentColor"></circle>
            </pattern>
          </defs>
          <rect width="100%" height="100%" fill="url(#travel-pattern)"></rect>
        </svg>
      </div>

      <div class="relative z-10 mx-auto max-w-7xl px-4 py-16 sm:px-6 lg:px-8">
        <div class="mb-12 grid gap-8 md:grid-cols-2 lg:grid-cols-4">
          <!-- Brand Section -->
          <FooterBrand lang={lang} />

          <!-- Travel Categories -->
          <FooterTravelCategories lang={lang} />

          <!-- Resources -->
          <FooterTravelResources lang={lang} />
        </div>

        <!-- Travel Stats -->
        <FooterTravelStats lang={lang} />

        <!-- Bottom Section -->
        <FooterBottom lang={lang} baseUrl={baseUrl} />
      </div>
    </footer>

    <script>
      // Theme toggle functionality
      const themeToggleBtn = document.getElementById('theme-toggle');
      const themeToggleDarkIcon = document.getElementById('theme-toggle-dark-icon');
      const themeToggleLightIcon = document.getElementById('theme-toggle-light-icon');

      function toggleTheme() {
        document.documentElement.classList.toggle('dark');

        const isDark = document.documentElement.classList.contains('dark');
        themeToggleLightIcon!.classList.toggle('hidden', !isDark);
        themeToggleDarkIcon!.classList.toggle('hidden', isDark);
      }

      function initThemeIcons() {
        const isDark = document.documentElement.classList.contains('dark');
        themeToggleLightIcon!.classList.toggle('hidden', !isDark);
        themeToggleDarkIcon!.classList.toggle('hidden', isDark);
      }

      themeToggleBtn?.addEventListener('click', toggleTheme);

      // Mobile menu toggle
      const mobileMenuButton = document.getElementById('mobile-menu-button');
      const mobileMenu = document.getElementById('mobile-menu');

      mobileMenuButton?.addEventListener('click', () => {
        mobileMenu?.classList.toggle('hidden');
      });

      // Dropdown hover effects
      document.addEventListener('DOMContentLoaded', () => {
        const dropdowns = document.querySelectorAll('.dropdown-wrapper');

        dropdowns.forEach(dropdown => {
          const menu = dropdown.querySelector('.dropdown-menu');
          if (menu) {
            dropdown.addEventListener('mouseenter', () => {
              menu.classList.remove('opacity-0', 'invisible');
              menu.classList.add('opacity-100', 'visible');
            });

            dropdown.addEventListener('mouseleave', () => {
              menu.classList.remove('opacity-100', 'visible');
              menu.classList.add('opacity-0', 'invisible');
            });
          }
        });
      });

      // Initialize theme icons on page load
      document.addEventListener('DOMContentLoaded', initThemeIcons);
    </script>
  </body>
</html>
