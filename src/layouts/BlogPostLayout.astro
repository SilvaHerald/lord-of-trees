---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import TravelPostMeta from '@components/blog/TravelPostMeta.astro';
import PhotoGallery from '@components/blog/PhotoGallery.astro';
import TravelTableOfContents from '@components/blog/TravelTableOfContents.astro';
import TravelShareButtons from '@components/blog/TravelShareButtons.astro';
import RelatedDestinations from '@components/blog/RelatedDestinations.astro';
import { defaultLang, useTranslations, type Language } from '@libs/i18n/config';
import type { BlogType } from '@interfaces/blog.interface';
import { getImageUrl } from '@utils/image';
import TravelMap from '@components/map/TravelMap.astro';
import QuickTripInfo from '@components/blog/QuickTripInfo.astro';
import TravelRandomTip from '@components/blog/TravelRandomTip.astro';
import Newsletter from '@components/blog/Newsletter.astro';
import ReadingProgressBar from '@components/blog/ReadingProgressBar.astro';
import AuthorBio from '@components/blog/AuthorBio.astro';
import ScrollIndicator from '@components/blog/ScrollIndicator.astro';
import TravelTypeBadges from '@components/blog/TravelTypeBadges.astro';
import BreadCrumb from '@components/blog/BreadCrumb.astro';

export interface Props {
  pageTitle: string;
  pageDescription: string;
  postTitle: string;
  postDescription: string;
  publishDate: Date;
  lang?: Language;
  coverImage: string;
  destinations: {
    name: string;
    lat?: number;
    lng?: number;
    description?: string;
  }[];
  country: string;
  province: string;
  travelDates: string;
  tripType: BlogType['tripType'];
  duration: string;
  budget: BlogType['budget'];
  photos: string[];
  headings: any[];
  relatedPosts?: CollectionEntry<'posts'>[];
  mapCoordinates?: { lat: number; lng: number };
  tips: string[];
}

const {
  pageTitle,
  pageDescription,
  postTitle,
  postDescription,
  publishDate,
  lang = defaultLang,
  coverImage,
  destinations,
  country,
  province,
  travelDates,
  tripType,
  duration,
  budget,
  photos,
  headings,
  relatedPosts,
  mapCoordinates,
  tips,
} = Astro.props;

const t = useTranslations(lang as Language);
---

<BaseLayout title={pageTitle} description={pageDescription} lang={lang as Language}>
  <article
    class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900"
  >
    <!-- Hero Section -->
    <header class="relative min-h-[60vh] overflow-hidden md:min-h-[80vh]">
      {
        coverImage && (
          <div class="absolute inset-0">
            <img src={getImageUrl(coverImage)} alt={postTitle} class="h-full w-full object-cover" />
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-slate-900/20 to-transparent" />
            <div class="absolute inset-0 bg-gradient-to-br from-amber-900/20 to-orange-900/20" />
          </div>
        )
      }

      <div class="absolute inset-0 flex items-end">
        <div class="mx-auto w-full max-w-4xl px-4 pb-16 sm:px-6 md:pb-24 lg:px-8">
          <!-- Breadcrumb -->
          <BreadCrumb lang={lang} postTitle={postTitle} />

          <!-- Travel Type Badge -->
          <TravelTypeBadges lang={lang} tripType={tripType} />

          <!-- Article Header -->
          <h1
            class="mb-6 text-4xl leading-tight font-bold text-balance text-white md:text-5xl lg:text-6xl"
          >
            {postTitle}
          </h1>

          <p class="mb-8 max-w-3xl text-lg leading-relaxed text-balance text-white/90 md:text-xl">
            {postDescription}
          </p>

          <TravelPostMeta
            lang={lang as Language}
            publishDate={publishDate}
            destinations={destinations}
            country={country}
            province={province}
            travelDates={travelDates}
            duration={duration}
            budget={budget}
            class="text-white"
          />
        </div>
      </div>

      <!-- Scroll indicator -->
      <ScrollIndicator />
    </header>

    <!-- Main Content -->
    <div class="relative z-10 bg-white dark:bg-slate-900">
      <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 md:py-16 lg:px-8">
        <div class="grid gap-12 lg:grid-cols-12">
          <!-- Table of Contents - Desktop -->
          <aside class="hidden lg:col-span-3 lg:block">
            <div class="sticky top-8">
              <TravelTableOfContents lang={lang as Language} headings={headings} />
            </div>
          </aside>

          <!-- Article Content -->
          <main class="lg:col-span-6">
            <!-- Mobile TOC -->
            <details
              class="mb-8 rounded-xl border border-amber-200 bg-amber-50 p-4 lg:hidden dark:border-slate-700 dark:bg-slate-800"
            >
              <summary
                class="flex cursor-pointer items-center font-semibold text-slate-900 hover:text-amber-600 dark:text-white dark:hover:text-amber-400"
              >
                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                {t('post.mobileChapters')}
              </summary>
              <div class="mt-4">
                <TravelTableOfContents lang={lang as Language} headings={headings} />
              </div>
            </details>

            <!-- Photo Gallery -->
            {
              photos && photos.length > 0 && (
                <div class="mb-12">
                  <PhotoGallery lang={lang as Language} photos={photos} />
                </div>
              )
            }

            <!-- Article Body -->
            <div class="prose-travel max-w-none font-sans">
              <slot />
            </div>

            <!-- Map Section -->
            {
              mapCoordinates && (
                <TravelMap
                  lang={lang as Language}
                  mapCoordinates={mapCoordinates}
                  country={country}
                  province={province}
                  destinations={destinations}
                  zoom={10}
                />
              )
            }

            <!-- Share Buttons -->
            <div class="mt-16 border-t border-slate-200 pt-8 dark:border-slate-700">
              <TravelShareButtons lang={lang as Language} title={postTitle} />
            </div>

            <!-- Author Bio -->
            <AuthorBio lang={lang} />
          </main>

          <!-- Sidebar -->
          <aside class="lg:col-span-3">
            <div class="sticky top-8 space-y-8">
              <!-- Reading Progress -->
              <ReadingProgressBar lang={lang} />

              <!-- Quick Trip Info -->
              <QuickTripInfo
                lang={lang as Language}
                destinations={destinations}
                travelDates={travelDates}
                duration={duration}
                budget={budget}
              />

              <!-- Related Destinations -->
              {
                relatedPosts && relatedPosts.length > 0 && (
                  <RelatedDestinations lang={lang as Language} posts={relatedPosts} />
                )
              }

              <!-- Random Travel Tip -->
              <TravelRandomTip lang={lang as Language} tips={tips} />

              <!-- Newsletter CTA -->
              <Newsletter lang={lang} />

            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  // Reading progress indicator
  function updateReadingProgress() {
    const article = document.querySelector('main');
    const progressBar = document.getElementById('reading-progress');

    if (!article || !progressBar) return;

    const articleHeight = article.offsetHeight;
    const articleTop = article.offsetTop;
    const scrollPosition = window.scrollY;
    const windowHeight = window.innerHeight;

    const progress = Math.min(
      Math.max((scrollPosition - articleTop + windowHeight) / articleHeight, 0),
      1
    );

    progressBar.style.width = `${progress * 100}%`;
  }

  window.addEventListener('scroll', updateReadingProgress);
  window.addEventListener('resize', updateReadingProgress);

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', updateReadingProgress);

  // Smooth scroll for internal links
  document.addEventListener('DOMContentLoaded', () => {
    const links = document.querySelectorAll('a[href^="#"]');

    links.forEach(link => {
      link.addEventListener('click', e => {
        e.preventDefault();
        const target = document.querySelector(link.getAttribute('href')!);

        if (target) {
          target.scrollIntoView({
            behavior: 'smooth',
            block: 'start',
          });
        }
      });
    });
  });
</script>
