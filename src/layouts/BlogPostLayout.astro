---
import type { CollectionEntry } from 'astro:content';
import BaseLayout from './BaseLayout.astro';
import TravelPostMeta from '@components/blog/TravelPostMeta.astro';
import PhotoGallery from '@components/blog/PhotoGallery.astro';
import TravelTableOfContents from '@components/blog/TravelTableOfContents.astro';
import TravelShareButtons from '@components/blog/TravelShareButtons.astro';
import RelatedDestinations from '@components/blog/RelatedDestinations.astro';
import { defaultLang, useTranslations, type Language } from '@libs/i18n/config';
import type { BlogType } from '@interfaces/blog.interface';
import { getImageUrl } from '@utils/image';
import TravelMap from '@components/map/TravelMap.astro';
import QuickTripInfo from '@components/blog/QuickTripInfo.astro';
import TravelRandomTip from '@components/blog/TravelRandomTip.astro';
import Newsletter from '@components/blog/Newsletter.astro';
import AuthorBio from '@components/blog/AuthorBio.astro';
import ScrollIndicator from '@components/blog/ScrollIndicator.astro';
import TravelTypeBadges from '@components/blog/TravelTypeBadges.astro';
import BreadCrumb from '@components/blog/BreadCrumb.astro';
import ProgressBar from '@components/blog/ProgressBar.astro';
import type { MarkdownHeading } from 'astro';
import CollapsibleSidebar from '../components/CollapsibleSidebar.astro';

export interface Props {
  pageTitle: string;
  pageDescription: string;
  postTitle: string;
  postDescription: string;
  publishDate: Date;
  lang?: Language;
  coverImage: string;
  destinations: {
    name: string;
    lat?: number;
    lng?: number;
    description?: string;
  }[];
  country: string;
  province: string;
  travelDates: string;
  tripType: BlogType['tripType'];
  duration: string;
  budget: BlogType['budget'];
  photos: string[];
  headings: MarkdownHeading[];
  relatedPosts?: CollectionEntry<'posts'>[];
  mapCoordinates?: { lat: number; lng: number };
  tips: string[];
}

const {
  pageTitle,
  pageDescription,
  postTitle,
  postDescription,
  publishDate,
  lang = defaultLang,
  coverImage,
  destinations,
  country,
  province,
  travelDates,
  tripType,
  duration,
  budget,
  photos,
  headings,
  relatedPosts,
  mapCoordinates,
  tips,
} = Astro.props;

const t = useTranslations(lang);
---

<BaseLayout title={pageTitle} description={pageDescription} lang={lang}>
  <article
    class="min-h-screen bg-gradient-to-br from-amber-50 via-orange-50 to-red-50 dark:from-slate-900 dark:via-slate-800 dark:to-slate-900"
  >
    <!-- Hero Section -->
    <header class="relative min-h-[100vh] 2xs:min-h-[80vh] overflow-hidden">
      {
        coverImage && (
          <div class="absolute inset-0">
            <img src={getImageUrl(coverImage)} alt={postTitle} class="h-full w-full object-cover" />
            <div class="absolute inset-0 bg-gradient-to-t from-slate-900/80 via-slate-900/20 to-transparent" />
            <div class="absolute inset-0 bg-gradient-to-br from-amber-900/20 to-orange-900/20" />
          </div>
        )
      }

      <div class="absolute inset-0 flex items-end">
        <div class="mx-auto w-full max-w-4xl px-4 pb-16 sm:px-6 md:pb-24 lg:px-8">
          <!-- Breadcrumb -->
          <BreadCrumb lang={lang} postTitle={postTitle} />

          <!-- Travel Type Badge -->
          <TravelTypeBadges lang={lang} tripType={tripType} />

          <!-- Article Header -->
          <h1
            class="mb-6 text-4xl leading-tight font-bold text-balance text-white md:text-5xl lg:text-6xl"
          >
            {postTitle}
          </h1>

          <p class="mb-8 max-w-3xl text-lg leading-relaxed text-balance text-white/90 md:text-xl">
            {postDescription}
          </p>

          <TravelPostMeta
            lang={lang}
            publishDate={publishDate}
            destinations={destinations}
            country={country}
            province={province}
            travelDates={travelDates}
            duration={duration}
            budget={budget}
            class="text-white"
          />
        </div>
      </div>

      <!-- Scroll indicator -->
      <ScrollIndicator />
    </header>

    <!-- Main Content -->
    <div class="relative z-10 bg-white dark:bg-slate-900">
      <div class="mx-auto max-w-7xl px-4 py-12 sm:px-6 md:py-16 lg:px-8">
        <div class="grid gap-12 lg:grid-cols-12">
          <!-- Table of Contents - Desktop -->
          <aside class="hidden lg:col-span-3 lg:block">
            <div class="sticky top-24">
              <TravelTableOfContents lang={lang} headings={headings} />
            </div>
          </aside>

          <!-- Article Content -->
          <main class="lg:col-span-6">
            <!-- Mobile TOC -->
            <details
              class="mb-8 rounded-xl border border-amber-200 bg-amber-50 p-4 lg:hidden dark:border-slate-700 dark:bg-slate-800"
            >
              <summary
                class="flex cursor-pointer items-center font-semibold text-slate-900 hover:text-amber-600 dark:text-white dark:hover:text-amber-400"
              >
                <svg class="mr-2 h-5 w-5" fill="none" stroke="currentColor" viewBox="0 0 24 24">
                  <path
                    stroke-linecap="round"
                    stroke-linejoin="round"
                    stroke-width="2"
                    d="M4 6h16M4 10h16M4 14h16M4 18h16"></path>
                </svg>
                {t('post.mobileChapters')}
              </summary>
              <div class="mt-4">
                <TravelTableOfContents lang={lang} headings={headings} />
              </div>
            </details>

            <!-- Photo Gallery -->
            {
              photos && photos.length > 0 && (
                <div class="mb-12">
                  <PhotoGallery lang={lang} photos={photos} />
                </div>
              )
            }

            <!-- Article Body -->
            <div class="prose-travel max-w-none font-sans">
              <slot />
            </div>

            <!-- Map Section -->
            {
              mapCoordinates && (
                <TravelMap
                  lang={lang}
                  mapCoordinates={mapCoordinates}
                  country={country}
                  province={province}
                  destinations={destinations}
                  zoom={10}
                />
              )
            }

            <!-- Share Buttons -->
            <div class="mt-16 border-t border-slate-200 pt-8 dark:border-slate-700">
              <TravelShareButtons lang={lang} title={postTitle} />
            </div>

            <!-- Author Bio -->
            <AuthorBio lang={lang} />
          </main>

          <!-- Sidebar -->
          <aside class="lg:col-span-3">
            <!-- Reading Progress -->

            <div class="sticky top-24 space-y-8">
              <ProgressBar lang={lang} />

              <CollapsibleSidebar
                title={t('post.tripDetails')}
                icon='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M13 16h-1v-4h-1m1-4h.01M21 12a9 9 0 11-18 0 9 9 0 0118 0z"></path>'
                id="trip-details"
                theme="default"
                defaultOpen={true}
              >
                <QuickTripInfo
                  lang={lang}
                  destinations={destinations}
                  travelDates={travelDates}
                  duration={duration}
                  budget={budget}
                />
              </CollapsibleSidebar>

              <!-- Related Destinations -->
              {
                relatedPosts && relatedPosts.length > 0 && (
                  <CollapsibleSidebar
                    title={t('post.relatedTitle')}
                    icon='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9 20l-5.447-2.724A1 1 0 013 16.382V5.618a1 1 0 011.447-.894L9 7m0 13l6-3m-6 3V7m6 10l4.553 2.276A1 1 0 0021 18.382V7.618a1 1 0 00-.553-.894L15 4m0 13V4m0 0L9 7"></path>'
                    id="related-destinations"
                    theme="blue"
                    defaultOpen={true}
                  >
                    <RelatedDestinations lang={lang} posts={relatedPosts} />
                  </CollapsibleSidebar>
                )
              }

              <!-- Random Travel Tip -->
              <CollapsibleSidebar
                title={t('post.travelTip')}
                icon='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M9.663 17h4.673M12 3v1m6.364 1.636l-.707.707M21 12h-1M4 12H3m3.343-5.657l-.707-.707m2.828 9.9a5 5 0 117.072 0l-.548.547A3.374 3.374 0 0014 18.469V19a2 2 0 11-4 0v-.531c0-.895-.356-1.754-.988-2.386l-.548-.547z"></path>'
                id="travel-tip"
                theme="green"
                defaultOpen={true}
              >
                <TravelRandomTip lang={lang} tips={tips} />
              </CollapsibleSidebar>

              <!-- Newsletter CTA -->
              <CollapsibleSidebar
                title={t('post.newsletter')}
                icon='<path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M3 8l7.89 5.26a2 2 0 002.22 0L21 8M5 19h14a2 2 0 002-2V7a2 2 0 00-2-2H5a2 2 0 00-2 2v10a2 2 0 002 2z"></path>'
                id="newsletter"
                theme="orange"
                defaultOpen={true}
              >
                <Newsletter lang={lang} />
              </CollapsibleSidebar>
            </div>
          </aside>
        </div>
      </div>
    </div>
  </article>
</BaseLayout>

<script>
  // Reading progress indicator
  function updateReadingProgress() {
    const article = document.querySelector('main');
    const progressBar = document.getElementById('reading-progress');

    if (!article || !progressBar) return;

    const articleHeight = article.offsetHeight;
    const articleTop = article.offsetTop;
    const scrollPosition = window.scrollY;
    const windowHeight = window.innerHeight;

    const progress = Math.min(
      Math.max((scrollPosition - articleTop + windowHeight) / articleHeight, 0),
      1
    );

    progressBar.style.width = `${progress * 100}%`;
  }

  window.addEventListener('scroll', updateReadingProgress);
  window.addEventListener('resize', updateReadingProgress);

  // Initialize on page load
  document.addEventListener('DOMContentLoaded', updateReadingProgress);

  // Smooth scroll for internal links
  // document.addEventListener('DOMContentLoaded', () => {
  //   const links = document.querySelectorAll('.travel-toc a[href^="#"]');

  //   links.forEach(link => {
  //     link.addEventListener('click', e => {
  //       e.preventDefault();

  //       const id = link.getAttribute('href')!.slice(1); // remove "#"
  //       const target = document.getElementById(id);

  //       if (target) {
  //         target.scrollIntoView({
  //           behavior: 'smooth',
  //           block: 'start',
  //         });
  //       }
  //     });
  //   });
  // });
</script>
