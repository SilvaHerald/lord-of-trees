---
import BlogPostLayout from '@layouts/BlogPostLayout.astro';
import { defaultLang, useTranslations } from '@libs/i18n/config';
import { type CollectionEntry, getCollection } from 'astro:content';

export async function getStaticPaths() {
  const posts = await getCollection('posts');

  return posts.map(post => ({
    params: { slug: post.slug.replace('en/', '') },
    props: post,
  }));
}

type Props = CollectionEntry<'posts'>;

const post = Astro.props;
const { Content, headings } = await post.render();

const t = useTranslations(defaultLang);

// Get related posts based on shared destinations or countries
const allPosts = await getCollection('posts');
const relatedPosts = allPosts
  .filter(
    p =>
      p.data.lang === 'en' &&
      p.slug !== post.slug &&
      !p.data.draft &&
      // Posts with shared destinations
      (p.data.destinations?.some(dest => post.data.destinations?.includes(dest)) ||
        // Posts with shared countries
        p.data.countries?.some(country => post.data.countries?.includes(country)) ||
        // Posts with same trip type
        (p.data.tripType === post.data.tripType && post.data.tripType) ||
        // Fallback to shared regular tags
        p.data.tags?.some(tag => post.data.tags?.includes(tag)))
  )
  .slice(0, 3);
---

<BlogPostLayout
  pageTitle={t('stories.pageTitle', post.data.title)}
  pageDescription={t('stories.pageDescription', post.data.description)}
  postTitle={post.data.title}
  postDescription={post.data.description}
  publishDate={post.data.publishDate}
  coverImage={post.data.coverImage}
  destinations={post.data.destinations}
  countries={post.data.countries}
  travelDates={post.data.travelDates}
  tripType={post.data.tripType}
  duration={post.data.duration}
  budget={post.data.budget}
  photos={post.data.photos}
  headings={headings}
  relatedPosts={relatedPosts}
  mapCoordinates={post.data.mapCoordinates}
  tips={post.data.travelTips!}
>
  <Content />
</BlogPostLayout>
