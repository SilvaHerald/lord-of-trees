---
import {
  languages,
  type Language,
  getLangFromUrl,
  getLocalizedPath,
  removeLanguagePrefix,
} from '@libs/i18n/config';

const currentLang = getLangFromUrl(Astro.url);
const currentPath = removeLanguagePrefix(Astro.url.pathname);
---

<div class="group relative">
  <button
    id="language-switcher-btn"
    type="button"
    class="flex items-center space-x-2 rounded-lg px-3 py-2 text-sm font-medium text-slate-700 transition-colors hover:bg-amber-100 dark:text-slate-300 dark:hover:bg-slate-700"
    aria-label="Change language"
  >
    <!-- Globe icon -->
    <svg class="h-5 w-5" fill="currentColor" viewBox="0 0 512 512">
      <path
        d="M 248.50 511.07 C240.61,509.12 231.62,502.04 227.96,494.90 C224.04,487.25 223.90,482.42 224.20,364.00 L 224.50 249.50 L 227.30 243.50 C230.94,235.71 235.78,230.84 243.37,227.33 L 249.50 224.50 L 318.34 224.50 L 387.17 224.50 L 389.59 227.31 C392.54,230.73 392.63,232.93 389.95,236.33 L 387.91 238.93 L 319.70 239.22 C252.97,239.49 251.42,239.54 248.00,241.55 C243.18,244.39 240.25,249.14 239.51,255.30 C239.17,258.16 239.03,310.90 239.20,372.50 C239.47,474.49 239.65,484.77 241.15,487.50 C243.30,491.39 246.78,494.60 250.32,495.93 C252.25,496.67 289.17,497.00 368.35,497.00 L 483.58 497.00 L 488.04 494.75 C491.30,493.11 493.11,491.30 494.75,488.04 L 497.00 483.58 L 497.00 368.35 C497.00,289.17 496.67,252.25 495.93,250.32 C494.60,246.78 491.39,243.30 487.50,241.15 C484.92,239.73 479.47,239.43 448.17,239.00 C413.67,238.53 411.76,238.40 410.42,236.56 C407.37,232.38 409.16,226.84 414.13,225.11 C418.34,223.64 477.51,223.61 485.57,225.08 C495.94,226.96 503.57,232.68 508.83,242.50 L 511.50 247.50 L 511.50 368.00 L 511.50 488.50 L 509.36 493.12 C506.29,499.76 500.68,505.52 494.16,508.72 L 488.50 511.50 L 370.00 511.66 C304.83,511.74 250.15,511.48 248.50,511.07 ZM 164.36 446.83 C161.60,445.49 159.83,441.54 160.60,438.45 C160.97,436.97 164.22,433.75 168.86,430.26 L 176.50 424.50 L 159.00 423.90 C149.38,423.57 139.25,422.72 136.50,422.01 C118.35,417.30 102.75,404.47 94.53,387.50 C88.94,375.94 88.00,368.79 88.00,337.68 C88.00,311.46 88.09,310.15 90.07,307.63 C92.67,304.33 98.02,304.02 101.00,307.00 C102.90,308.90 103.00,310.35 103.02,336.25 C103.04,366.88 103.86,373.21 109.13,383.09 C115.87,395.73 129.55,405.57 143.68,407.94 C147.43,408.57 156.50,408.95 163.83,408.79 L 177.16 408.50 L 169.62 403.00 C165.48,399.98 161.60,396.35 161.00,394.93 C158.92,390.05 162.61,385.00 168.26,385.00 C170.51,385.00 204.30,409.30 206.19,412.28 C206.62,412.95 206.98,414.92 206.98,416.66 C207.00,420.27 205.24,421.91 185.55,436.59 C168.90,449.00 168.87,449.01 164.36,446.83 ZM 306.63 445.93 C304.93,444.59 304.00,442.88 304.00,441.12 C304.00,439.61 309.13,424.91 315.40,408.44 C321.66,391.97 334.06,359.38 342.95,336.00 C354.75,304.94 359.77,292.89 361.61,291.25 C363.43,289.61 365.35,289.00 368.67,289.00 C376.82,289.00 372.35,278.76 422.64,412.38 C432.00,437.25 433.01,440.56 432.00,443.00 C430.90,445.65 427.38,448.00 424.51,448.00 C421.04,448.00 418.01,443.09 412.86,429.10 C409.95,421.19 406.98,414.12 406.26,413.40 C404.38,411.52 331.67,411.49 330.11,413.37 C329.53,414.07 326.83,420.52 324.11,427.71 C321.39,434.90 318.47,442.13 317.62,443.77 C315.16,448.52 310.98,449.34 306.63,445.93 ZM 384.90 354.87 C376.16,331.69 368.99,312.46 368.97,312.12 C368.89,310.44 366.02,317.58 352.18,354.00 C343.92,375.73 336.85,394.29 336.47,395.25 C335.83,396.89 337.74,397.00 368.30,397.00 L 400.80 397.00 L 384.90 354.87 ZM 24.85 286.63 C15.57,284.62 8.13,278.74 3.18,269.50 L 0.50 264.50 L 0.50 144.00 L 0.50 23.50 L 3.28 17.84 C6.48,11.32 12.24,5.71 18.88,2.64 L 23.50 0.50 L 144.00 0.50 L 264.50 0.50 L 269.69 3.24 C275.67,6.39 281.40,11.92 284.05,17.10 C287.86,24.56 288.09,30.69 287.79,118.15 C287.51,199.76 287.43,202.87 285.60,204.90 C283.24,207.50 278.04,207.68 275.12,205.25 L 273.01 203.50 L 272.75 115.50 C272.52,35.79 272.34,27.22 270.85,24.50 C268.70,20.61 265.22,17.40 261.68,16.07 C259.75,15.33 222.83,15.00 143.65,15.00 L 28.42 15.00 L 23.96 17.25 C20.70,18.89 18.89,20.70 17.25,23.96 L 15.00 28.42 L 15.00 143.65 C15.00,222.83 15.33,259.75 16.07,261.68 C17.40,265.22 20.61,268.70 24.50,270.85 C27.21,272.34 36.09,272.55 115.60,273.00 C188.25,273.41 203.98,273.74 205.35,274.87 C207.78,276.89 207.51,283.23 204.90,285.60 C202.86,287.43 199.82,287.51 116.65,287.67 C51.93,287.81 29.10,287.54 24.85,286.63 ZM 90.07 220.37 C86.03,215.22 87.85,212.00 98.83,204.87 C109.04,198.25 121.54,188.23 128.38,181.19 L 133.26 176.17 L 125.84 166.32 C116.89,154.44 109.71,142.71 103.43,129.72 C99.15,120.88 98.85,119.78 99.96,117.10 C100.65,115.43 102.48,113.63 104.22,112.91 C109.18,110.86 111.48,113.01 118.22,126.00 C124.50,138.12 131.81,149.66 139.29,159.28 L 143.78 165.06 L 149.51 157.44 C161.46,141.57 171.30,123.79 178.60,104.87 C180.47,100.03 182.00,95.83 182.00,95.54 C182.00,95.24 156.55,95.00 125.45,95.00 L 68.91 95.00 L 66.45 92.55 C65.10,91.20 64.00,88.93 64.00,87.50 C64.00,86.07 65.10,83.80 66.45,82.45 L 68.91 80.00 L 102.45 80.00 L 136.00 80.00 L 136.00 75.55 C136.00,69.96 137.53,66.54 140.66,65.11 C144.08,63.55 145.36,63.71 148.37,66.07 C150.68,67.90 151.00,68.86 151.00,74.07 L 151.00 80.00 L 184.37 80.00 C216.61,80.00 217.82,80.07 220.37,82.07 C223.37,84.43 223.94,89.33 221.58,92.56 C220.37,94.22 218.56,94.57 208.97,95.00 L 197.77 95.50 L 193.93 106.50 C186.69,127.24 171.77,154.18 158.58,170.36 L 153.80 176.21 L 157.61 180.12 C163.60,186.25 177.73,197.53 188.58,204.85 C197.85,211.10 198.52,211.78 198.81,215.21 C199.19,219.80 196.37,223.00 191.93,223.00 C186.78,223.00 165.68,208.21 150.77,194.15 L 144.00 187.76 L 137.42 193.63 C125.00,204.70 119.48,209.08 109.21,216.04 C97.40,224.03 93.63,224.88 90.07,220.37 ZM 411.00 205.00 C409.10,203.10 409.00,201.65 408.98,175.75 C408.96,145.12 408.14,138.79 402.87,128.91 C396.13,116.27 382.45,106.43 368.32,104.06 C364.57,103.43 355.50,103.05 348.17,103.21 L 334.84 103.50 L 342.38 109.00 C346.52,112.03 350.40,115.65 351.00,117.07 C353.08,121.95 349.39,127.00 343.74,127.00 C341.49,127.00 307.70,102.70 305.81,99.72 C305.38,99.05 305.02,97.07 305.02,95.32 C305.00,91.71 305.18,91.55 326.50,75.52 C333.65,70.15 340.49,65.30 341.70,64.74 C344.79,63.32 349.53,65.45 350.96,68.90 C352.73,73.17 350.91,76.14 342.87,82.09 L 335.57 87.50 L 353.03 88.10 C362.64,88.43 372.75,89.28 375.50,89.99 C393.18,94.58 408.99,107.34 417.06,123.55 C422.90,135.26 423.26,137.83 423.73,171.01 C424.16,201.07 424.14,201.56 422.01,204.26 C419.33,207.67 414.02,208.02 411.00,205.00 Z"
      ></path>
    </svg>
    <span class="uppercase">{currentLang}</span>
    <svg class="h-4 w-4" fill="none" stroke="currentColor" viewBox="0 0 24 24">
      <path stroke-linecap="round" stroke-linejoin="round" stroke-width="2" d="M19 9l-7 7-7-7"
      ></path>
    </svg>
  </button>

  <!-- Dropdown menu -->
  <div
    id="language-dropdown"
    class="absolute right-0 z-50 mt-2 hidden max-h-80 w-48 overflow-y-auto rounded-lg border border-slate-200 bg-white shadow-xl dark:border-slate-700 dark:bg-slate-800"
  >
    <div class="p-2">
      {
        Object.entries(languages).map(([lang, label]) => {
          const localizedPath = getLocalizedPath(currentPath, lang as Language);
          const isActive = lang === currentLang;

          return (
            <a
              href={localizedPath}
              class={`block rounded-md px-3 py-2 text-sm transition-colors ${
                isActive
                  ? 'bg-amber-100 font-medium text-amber-700 dark:bg-amber-900/30 dark:text-amber-300'
                  : 'text-slate-700 hover:bg-amber-50 dark:text-slate-300 dark:hover:bg-slate-700'
              }`}
            >
              <div class="flex items-center justify-between">
                <span>{label}</span>
                {isActive && (
                  <svg
                    class="h-4 w-4 text-amber-600 dark:text-amber-400"
                    fill="currentColor"
                    viewBox="0 0 20 20"
                  >
                    <path
                      fill-rule="evenodd"
                      d="M16.707 5.293a1 1 0 010 1.414l-8 8a1 1 0 01-1.414 0l-4-4a1 1 0 011.414-1.414L8 12.586l7.293-7.293a1 1 0 011.414 0z"
                      clip-rule="evenodd"
                    />
                  </svg>
                )}
              </div>
            </a>
          );
        })
      }
    </div>
  </div>
</div>

<script>
  document.addEventListener('DOMContentLoaded', () => {
    const button = document.getElementById('language-switcher-btn');
    const dropdown = document.getElementById('language-dropdown');

    if (!button || !dropdown) return;

    button.addEventListener('click', e => {
      e.stopPropagation();
      dropdown.classList.toggle('hidden');
    });

    // Close dropdown when clicking outside
    document.addEventListener('click', () => {
      dropdown.classList.add('hidden');
    });

    // Prevent dropdown from closing when clicking inside
    dropdown.addEventListener('click', e => {
      e.stopPropagation();
    });
  });
</script>
