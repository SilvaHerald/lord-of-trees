---
import { defaultLang, useTranslations, type Language } from '@libs/i18n/config';

interface Props {
  lang?: Language;
  mapCoordinates: { lat: number; lng: number };
  zoom?: number;
  country: string;
  province: string;
  destinations: Array<{
    name: string;
    lat?: number;
    lng?: number;
    description?: string;
  }>;
}

const {
  lang = defaultLang,
  mapCoordinates: { lat, lng },
  zoom = 10,
  country,
  province,
  destinations = [],
} = Astro.props;

const mapId = `map-${Math.random().toString(36).substring(2, 9)}`;

let mapTitle = `${province}, ${country}`;

const t = useTranslations(lang as Language);
---

<div class="mb-8">
  <div class="flex items-center gap-2 mb-4">
    <svg class="w-6 h-6 text-orange-500" fill="currentColor" viewBox="0 0 24 24">
      <path d="M12 2C8.13 2 5 5.13 5 9c0 5.25 7 13 7 13s7-7.75 7-13c0-3.87-3.13-7-7-7zm0 9.5c-1.38 0-2.5-1.12-2.5-2.5s1.12-2.5 2.5-2.5 2.5 1.12 2.5 2.5-1.12 2.5-2.5 2.5z"/>
    </svg>
    <h3 class="text-2xl font-bold text-gray-900 dark:text-white">
      {t('post.map')}
    </h3>
  </div>

  <div
    id={mapId}
    class="h-96 w-full rounded-lg shadow-lg border-2 border-gray-200 dark:border-gray-700 leaflet-map"
    data-lat={lat}
    data-lng={lng}
    data-zoom={zoom}
    data-title={mapTitle}
    data-destinations={JSON.stringify(destinations)}
  ></div>

  <p class="text-sm text-gray-600 dark:text-gray-400 mt-2 text-center">
    <span class="font-medium">{mapTitle}</span> - {t('post.coordinates')}: [{lat.toFixed(4)}, {lng.toFixed(4)}]
  </p>
</div>

<script>
  import L from 'leaflet';
  import 'leaflet/dist/leaflet.css';

  function initTravelMaps() {
    const mapElements = document.querySelectorAll('.leaflet-map');

    // Create Intersection Observer to init map when scrolled into view
    const observer = new IntersectionObserver(
      (entries) => {
        entries.forEach((entry) => {
          if (entry.isIntersecting) {
            const mapElement = entry.target as HTMLElement;

            // Skip if already initialized
            if (mapElement.classList.contains('map-initialized')) return;
            mapElement.classList.add('map-initialized');

            // Stop observing this element
            observer.unobserve(mapElement);

            // Initialize the map
            initSingleMap(mapElement);
          }
        });
      },
      {
        threshold: 0.1, // Trigger when 10% of map is visible
        rootMargin: '50px' // Start loading 50px before it comes into view
      }
    );

    // Observe all map elements
    mapElements.forEach((mapElement) => observer.observe(mapElement));
  }

  function initSingleMap(mapElement: HTMLElement) {
    const mapId = mapElement.id;
    const lat = parseFloat(mapElement.getAttribute('data-lat') || '0');
    const lng = parseFloat(mapElement.getAttribute('data-lng') || '0');
    const zoom = parseInt(mapElement.getAttribute('data-zoom') || '10');
    const title = mapElement.getAttribute('data-title') || 'Location';
    const destinations = JSON.parse(mapElement.getAttribute('data-destinations') || '[]');

    // Add loading indicator
    mapElement.innerHTML = '<div class="flex items-center justify-center h-full"><div class="text-gray-500 dark:text-gray-400">Loading map...</div></div>';

    // Create map with custom styling
    const map = L.map(mapId, {
      scrollWheelZoom: false, // Disable scroll zoom to prevent accidental zooming
    }).setView([lat, lng], zoom);

    // Add OpenStreetMap tiles
    L.tileLayer('https://{s}.tile.openstreetmap.org/{z}/{x}/{y}.png', {
      attribution: 'Â© <a href="https://www.openstreetmap.org/copyright">OpenStreetMap</a> contributors',
      maxZoom: 19,
      className: 'map-tiles'
    }).addTo(map);

    // Custom marker icon (orange pin)
    const customIcon = L.icon({
      iconUrl: 'data:image/svg+xml;base64,' + btoa(`
        <svg width="32" height="42" viewBox="0 0 32 42" fill="none" xmlns="http://www.w3.org/2000/svg">
          <path d="M16 0C7.163 0 0 7.163 0 16c0 12 16 26 16 26s16-14 16-26c0-8.837-7.163-16-16-16z" fill="#F97316"/>
          <circle cx="16" cy="16" r="6" fill="white"/>
        </svg>
      `),
      iconSize: [32, 42],
      iconAnchor: [16, 42],
      popupAnchor: [0, -42]
    });

    // Add main marker
    const mainMarker = L.marker([lat, lng], { icon: customIcon }).addTo(map);
    mainMarker.bindPopup(`
      <div style="font-family: sans-serif;">
        <strong style="font-size: 16px; color: #F97316;">${title}</strong>
        <p style="margin: 5px 0 0 0; font-size: 14px;">Main location for this story</p>
      </div>
    `);

    // Add destination markers if provided
    destinations.forEach((dest: any) => {
      const destMarker = L.marker([dest.lat, dest.lng], { icon: customIcon }).addTo(map);
      destMarker.bindPopup(`
        <div style="font-family: sans-serif;">
          <strong style="font-size: 16px; color: #F97316;">${dest.name}</strong>
          ${dest.description ? `<p style="margin: 5px 0 0 0; font-size: 14px;">${dest.description}</p>` : ''}
        </div>
      `);
    });

    // Fit bounds if multiple destinations
    if (destinations.length > 0) {
      const allPoints = [[lat, lng], ...destinations.map((d: any) => [d.lat, d.lng])];
      const bounds = L.latLngBounds(allPoints as [number, number][]);
      map.fitBounds(bounds, { padding: [50, 50] });
    }

    // Enable zoom on click
    mapElement.addEventListener('click', function() {
      map.scrollWheelZoom.enable();
    });

    // Disable zoom when mouse leaves
    mapElement.addEventListener('mouseleave', function() {
      map.scrollWheelZoom.disable();
    });
  }

  // Initialize maps on page load
  if (document.readyState === 'loading') {
    document.addEventListener('DOMContentLoaded', initTravelMaps);
  } else {
    initTravelMaps();
  }

  // Re-initialize after Astro page navigation
  document.addEventListener('astro:page-load', initTravelMaps);
</script>

<style is:global>
  /* Leaflet map styling */
  .leaflet-map {
    z-index: 1;
  }

  .map-tiles {
    filter: brightness(0.95) contrast(1.05);
  }

  .dark .map-tiles {
    filter: brightness(0.7) contrast(1.1) saturate(0.8);
  }

  /* Fix Leaflet marker icons in production builds */
  .leaflet-default-icon-path {
    background-image: url('data:image/png;base64,iVBORw0KGgoAAAANSUhEUgAAAAEAAAABCAYAAAAfFcSJAAAADUlEQVR42mNkYPhfDwAChwGA60e6kgAAAABJRU5ErkJggg==');
  }

  /* Improve popup styling */
  .leaflet-popup-content-wrapper {
    border-radius: 8px;
    box-shadow: 0 4px 6px -1px rgba(0, 0, 0, 0.1), 0 2px 4px -1px rgba(0, 0, 0, 0.06);
  }

  .leaflet-popup-content {
    margin: 12px 16px;
    font-family: inherit;
  }

  .leaflet-popup-tip {
    box-shadow: 0 3px 14px rgba(0, 0, 0, 0.1);
  }

  /* Dark mode popup styling */
  .dark .leaflet-popup-content-wrapper {
    background: #1f2937;
    color: #f3f4f6;
  }

  .dark .leaflet-popup-tip {
    background: #1f2937;
  }

  .dark .leaflet-popup-close-button {
    color: #f3f4f6 !important;
  }

  .dark .leaflet-popup-close-button:hover {
    color: #f97316 !important;
  }
</style>
