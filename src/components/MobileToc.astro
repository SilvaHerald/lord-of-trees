---
import { defaultLang, useTranslations, type Language } from '@libs/i18n/config';
import type { MarkdownHeading } from 'astro';

export interface Props {
  lang?: Language;
  headings: MarkdownHeading[];
}

const { lang = defaultLang, headings } = Astro.props;

// Filter headings to only show h2 and h3
const tocHeadings = headings.filter(h => h.depth <= 3);
const t = useTranslations(lang);
---

<div id="toc-modal" class="fixed inset-0 z-50 hidden lg:hidden" role="dialog" aria-modal="true">
  <!-- Backdrop -->
  <div class="absolute inset-0 bg-black/40 backdrop-blur-sm"></div>

  <!-- Bottom Sheet -->
  <div class="absolute inset-x-0 bottom-0">
    <div
      class="mx-4 mb-4 flex max-h-[70vh] flex-col overflow-hidden rounded-3xl bg-white shadow-2xl dark:bg-slate-900"
    >
      <!-- Header -->
      <div
        class="flex items-center justify-between border-b border-slate-200 px-4 py-3 dark:border-slate-700"
      >
        <h2
          class="text-sm font-semibold tracking-wide text-slate-700 uppercase dark:text-slate-100"
        >
          {t('post.chapters')}
        </h2>
        <button id="toc-close" class="rounded-lg p-2 hover:bg-slate-100 dark:hover:bg-slate-800">
          âœ•
        </button>
      </div>

      <!-- TOC List -->
      <nav class="overflow-y-auto px-4 py-3 text-sm">
        <ul id="toc-list-mobile" class="space-y-2 text-sm">
          {
            tocHeadings.map(heading => (
              <li class={heading.depth === 3 ? 'ml-4' : ''}>
                <a
                  href={`#${heading.slug}`}
                  class="dark:hover:text-amber-40 block py-1 leading-tight text-slate-600 transition-colors hover:text-amber-600 dark:text-slate-300"
                >
                  {heading.text.endsWith(':') ? heading.text.slice(0, -1) : heading.text}
                </a>
              </li>
            ))
          }
        </ul>
      </nav>
    </div>
  </div>
</div>

<script>
  if (typeof window !== 'undefined') {
    const tocButton = document.getElementById('toc-toggle-mobile');
    const tocModal = document.getElementById('toc-modal');
    const tocClose = document.getElementById('toc-close');

    const openToc = () => tocModal?.classList.remove('hidden');
    const closeToc = () => tocModal?.classList.add('hidden');

    tocButton?.addEventListener('click', openToc);
    tocClose?.addEventListener('click', closeToc);

    // Close when clicking backdrop
    tocModal?.addEventListener('click', e => {
      if (e.target === tocModal) closeToc();
    });

    // Delegate clicks on TOC links
    const tocList = document.getElementById('toc-list-mobile');

    tocList?.addEventListener('click', e => {
      const target = e.target;
      if (target instanceof HTMLAnchorElement && target.hash) {
        e.preventDefault();
        const id = target.hash.slice(1);
        const heading = document.getElementById(id);
        if (heading) {
          heading.scrollIntoView({ behavior: 'smooth', block: 'start' });
          console.log('here')
          closeToc();
        }
      }
    });
  }
</script>
